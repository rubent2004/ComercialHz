{% extends "inventario/comun/base.html" %}

{% block content %}
<!-- NO MODIFICAR ---------------------------------->
{% load static %}
<script src='{% static "inventario/js/eliminarEntradas.js" %}'></script>
<!-- FIN DE JAVASCRIPT ------------------------------------>

<article class="content responsive-tables-page">
    <div class="title-block text-center">
        <h1 class="title">Registrar Devolución</h1>
        <p class="title-description">Registra los detalles de la devolución del producto</p>
    </div>
    <section class="section">
        <div class="row">
            <div class="col-md-12">
                {% if messages %}
                    {% for message in messages %}
                        <div class="card card-primary">
                            <div class="card-header">
                                <div class="header-block">
                                    <em class="fa fa-check"></em>
                                    <p class="title">{{ message }}</p>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                {% endif %}

                <div class="col-md-12">
                    <div class="card">
                        <div class="card-block">
                            <div class="card-title-block">
                                <h3 class="title">Formulario de Devolución</h3>
                            </div>
                            
                            <!-- Botón para listar devoluciones en la esquina superior derecha -->
                            <a href="{% url 'inventario:listarDev' %}" class="btn btn-lg" style="position: absolute; top: 20px; right: 20px; background-color: #007bff; color: white; border: 2px solid #007bff; border-radius: 25px; padding: 10px 20px; font-size: 16px; font-weight: 600; text-transform: uppercase; transition: background-color 0.3s ease, transform 0.2s ease;">
                                <i class="fa fa-list"></i> Listar Devoluciones
                            </a>

                            <section class="example">
                                <form method="post">
                                    {% csrf_token %}
                                    
                                    <!-- Campo Producto con Autocompletar -->
                                    <div class="form-group">
                                        <label for="idproducto">Producto</label>
                                        <input type="text" name="idproducto" id="producto_input" class="form-control" value="{{ form.idproducto.value }}" autocomplete="off">
                                        <ul id="producto_suggestions" class="suggestions-list"></ul>
                                    </div>

                                    <!-- Campo Bodega (ComboBox) -->
                                    <div class="form-group">
                                        <label for="idbodega">Bodega</label>
                                        {{ form.idbodega }}
                                    </div>

                                    <!-- Campo Empleado con Autocompletar -->
                                    <div class="form-group">
                                        <label for="idempleado">Empleado</label>
                                        <input type="text" name="idempleado" id="empleado_input" class="form-control" value="{{ form.idempleado.value }}" autocomplete="off">
                                        <ul id="empleado_suggestions" class="suggestions-list"></ul>
                                    </div>

                                    <!-- Campo Cantidad -->
                                    <div class="form-group">
                                        <label for="cantidad">Cantidad</label>
                                        {{ form.cantidad }}
                                    </div>

                                    <!-- Campo Motivo -->
                                    <div class="form-group">
                                        <label for="motivo">Motivo de la Devolución</label>
                                        {{ form.motivo }}
                                    </div>

                                    <!-- Campo Dañado -->
                                    <div class="form-group">
                                        <label for="dañado">Dañado</label>
                                        {{ form.dañado }}
                                    </div>

                                    <div class="d-flex justify-content-between">
                                        <!-- Botón para registrar devolución -->
                                        <button type="submit" class="btn btn-lg" style="background-color: #28a745; color: white; border: 2px solid #28a745; border-radius: 25px; padding: 10px 20px; font-size: 16px; font-weight: 600; text-transform: uppercase; transition: background-color 0.3s ease, transform 0.2s ease;">
                                            <i class="fa fa-check"></i> Registrar Devolución
                                        </button>
                                    </div>
                                </form>
                            </section>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
</article>

{% block extra_scripts %}
<script type="text/javascript">
    $(document).ready(function() {
        // Autocompletar para Producto
        $('#producto_input').on('input', function() {
            var query = $(this).val();
            if (query.length >= 2) {  // Solo buscar si se escriben 2 o más caracteres
                $.ajax({
                    url: '{% url "inventario:buscar_sugerencias_nombre" %}',  // URL para la búsqueda de productos
                    data: { 'nombre': query },
                    success: function(data) {
                        var suggestions = data;
                        $('#producto_suggestions').empty();
                        if (suggestions.length > 0) {
                            suggestions.forEach(function(suggestion) {
                                $('#producto_suggestions').append('<li data-id="' + suggestion.id + '">' + suggestion.descripcion + ' - $' + suggestion.precio_unitario + '</li>');
                            });
                        } else {
                            $('#producto_suggestions').append('<li>No se encontraron productos.</li>');
                        }
                    }
                });
            } else {
                $('#producto_suggestions').empty();
            }
        });

        // Autocompletar para Empleado
        $('#empleado_input').on('input', function() {
            var query = $(this).val();
            if (query.length >= 2) {  // Solo buscar si se escriben 2 o más caracteres
                $.ajax({
                    url: '{% url "inventario:buscar_sugerencias_empleado" %}',  // URL para la búsqueda de empleados
                    data: { 'nombre': query },
                    success: function(data) {
                        var suggestions = data;
                        $('#empleado_suggestions').empty();
                        if (suggestions.length > 0) {
                            suggestions.forEach(function(suggestion) {
                                $('#empleado_suggestions').append('<li data-id="' + suggestion.id + '">' + suggestion.nombre + ' ' + suggestion.apellido + '</li>');
                            });
                        } else {
                            $('#empleado_suggestions').append('<li>No se encontraron empleados.</li>');
                        }
                    }
                });
            } else {
                $('#empleado_suggestions').empty();
            }
        });

        // Manejo de selección de sugerencia
        $('#producto_suggestions').on('click', 'li', function() {
            var selectedId = $(this).data('id');
            var selectedText = $(this).text();
            $('#producto_input').val(selectedText);  // Rellenar el input con el texto de la sugerencia
            $('#producto_suggestions').empty();  // Vaciar las sugerencias
        });

        $('#empleado_suggestions').on('click', 'li', function() {
            var selectedId = $(this).data('id');
            var selectedText = $(this).text();
            $('#empleado_input').val(selectedText);  // Rellenar el input con el texto de la sugerencia
            $('#empleado_suggestions').empty();  // Vaciar las sugerencias
        });
    });
</script>
{% endblock %}

{% endblock %}
