{% extends "inventario/comun/base.html" %}

{% block content %}
<script>
    function abrirModal(productoId, maxCantidad, movimientoId, esDevuelto) {
        document.getElementById('productoId').value = productoId;
        document.getElementById('movimientoId').value = movimientoId;  
        console.log("Configurando producto ID:", productoId);
        console.log("Configurando Movimiento ID:", movimientoId);    
        document.getElementById('cantidadMaxima').innerText = maxCantidad;
        document.getElementById('cantidadVendida').max = maxCantidad;
        document.getElementById('cantidadRecibida').max = maxCantidad;
        document.getElementById('cantidadVendida').value = '';
        document.getElementById('cantidadRecibida').value = '';
        document.getElementById('bodegaDevuelta').value = '';
        document.getElementById('errorMensaje').innerText = ''; // Limpiar mensaje de error
        document.getElementById('esDevuelto').value = esDevuelto;
        const modal = new bootstrap.Modal(document.getElementById('recepcionModal'));
        modal.show();
    }

    function validarSuma(maxCantidad) {
        const cantidadVendida = parseInt(document.getElementById('cantidadVendida').value || 0, 10);
        const cantidadRecibida = parseInt(document.getElementById('cantidadRecibida').value || 0, 10);
        const bodegaDevuelta = document.getElementById('bodegaDevuelta').value;
        const suma = cantidadVendida + cantidadRecibida;

        if (suma > maxCantidad) {
            document.getElementById('errorMensaje').innerText = 
                `La suma de vendidos y devueltos (${suma}) no puede exceder la cantidad máxima (${maxCantidad}).`;
            document.getElementById('guardarBtn').disabled = true;
        } else if (cantidadRecibida > 0 && !bodegaDevuelta) {
            document.getElementById('errorMensaje').innerText = 
                "Debe seleccionar una bodega para los productos devueltos.";
            document.getElementById('guardarBtn').disabled = true;
        } else {
            document.getElementById('errorMensaje').innerText = '';
            document.getElementById('guardarBtn').disabled = false;
        }
    }
</script>

<article class="content responsive-tables-page">
    <div class="title-block text-center">
        <h1 class="title">Empleados con Productos Pendientes</h1>
        <p class="title-description">Ver empleados con productos pendientes de recepción</p>
    </div>

    <section class="section">
        <div class="row">
            <div class="col-md-12">
                <div class="card shadow-sm border-light">
                    <div class="card-block">
                        <div class="card-title-block d-flex justify-content-between align-items-center">
                            <h3 class="title">Empleados Pendientes</h3>
                            <i class="fas fa-boxes" style="font-size: 1.5em;"></i> <!-- Icono de cajas -->
                        </div>
                        <section class="example">
                            {% if messages %}
                                {% for message in messages %}
                                    <div class="alert alert-info">{{ message }}</div>
                                {% endfor %}
                            {% endif %}
                            <div class="table-responsive">
                                <table id="listarEmpleadosPendientes" class="table table-striped table-bordered table-hover">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Nombre</th>
                                            <th>Productos Pendientes</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for empleado_id, empleado_data in empleados.items %}
                                        <tr>
                                            <td>{{ empleado_data.nombre }} {{ empleado_data.apellido }}</td>
                                            <td>
                                                <ul class="list-unstyled">
                                                    {% for producto_id, producto_data in empleado_data.productos.items %}
                                                    <li class="d-flex justify-content-between align-items-center mb-3">
                                                        <span>
                                                            <i class="fas fa-box-open"></i> {{ producto_data.descripcion }} 
                                                            (Cantidad: {{ producto_data.cantidad }})
                                                        </span>
                                                        <button class="btn btn-info btn-sm" 
                                                                onclick="abrirModal('{{ producto_id }}', {{ producto_data.cantidad }}, {{ producto_data.movimiento_id }}, false)">
                                                          <i class="fas fa-check-circle"></i> Recepcionar
                                                        </button>
                                                        <button class="btn btn-warning btn-sm" 
                                                                onclick="abrirModal('{{ producto_id }}', {{ producto_data.cantidad }}, {{ producto_data.movimiento_id }}, true)">
                                                          <i class="fas fa-undo-alt"></i> Trae Devolucion
                                                        </button>
                                                    </li>
                                                    {% endfor %}
                                                </ul>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </section>
                    </div>
                </div>
            </div>
        </div>
    </section>
</article>

<!-- Modal para recepción -->
<div class="modal fade" id="recepcionModal" tabindex="-1" aria-labelledby="recepcionModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
      <div class="modal-content">
          <form method="POST" action="{% url 'inventario:recepcion_producto' %}">
              {% csrf_token %}
              <div class="modal-header bg-info text-white">
                  <h5 class="modal-title" id="recepcionModalLabel">Recepción de Producto</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                  <p><strong>Cantidad máxima pendiente:</strong> <span id="cantidadMaxima"></span></p>
                  <div class="mb-3">
                      <label for="cantidadVendida" class="form-label">Cantidad Vendida</label>
                      <input type="number" class="form-control" name="cantidad_vendida" id="cantidadVendida" 
                             min="0" oninput="validarSuma(parseInt(document.getElementById('cantidadMaxima').innerText))">
                      {% if form.cantidad_vendida.errors %}
                          <div class="invalid-feedback">
                              {% for error in form.cantidad_vendida.errors %}
                                  <p>{{ error }}</p>
                              {% endfor %}
                          </div>
                      {% endif %}
                  </div>
                  <div class="mb-3">
                      <label for="cantidadRecibida" class="form-label">Cantidad Devuelta</label>
                      <input type="number" class="form-control" name="cantidad_recibida" id="cantidadRecibida" 
                             min="0" oninput="validarSuma(parseInt(document.getElementById('cantidadMaxima').innerText))">
                      {% if form.cantidad_recibida.errors %}
                          <div class="invalid-feedback">
                              {% for error in form.cantidad_recibida.errors %}
                                  <p>{{ error }}</p>
                              {% endfor %}
                          </div>
                      {% endif %}
                  </div>
                  <div class="mb-3">
                      <label for="bodegaDevuelta" class="form-label">Bodega para devolución</label>
                      <select class="form-select" name="bodega_id" id="bodegaDevuelta" 
                              oninput="validarSuma(parseInt(document.getElementById('cantidadMaxima').innerText))">
                          <option value="" selected>Seleccione una bodega</option>
                          {% for bodega in bodegas %}
                          <option value="{{ bodega.id }}">{{ bodega.nombre }}</option>
                          {% endfor %}
                      </select>
                      {% if form.bodega_id.errors %}
                          <div class="invalid-feedback">
                              {% for error in form.bodega_id.errors %}
                                  <p>{{ error }}</p>
                              {% endfor %}
                          </div>
                      {% endif %}
                  </div>
                  <!-- Mostrar el ID de Movimiento de forma discreta -->
                  <p style="font-size: 0.8em; color: #6c757d;">
                    <strong>ID de Movimiento:</strong>
                    <input type="text" name="movimiento_id" id="movimientoId" value="" readonly 
                           style="border: none; background: transparent; font-size: 1.2em; color: #6c757d;">
                 </p>
                  <p style="font-size: 0.8em; color: #6c757d;">
                    <strong>ID de Producto:</strong>
                    <input type="text" name="producto_id" id="productoId" value="" readonly 
                          style="border: none; background: transparent; font-size: 1.2em; color: #6c757d;">
                </p>
                  <p id="errorMensaje" class="text-danger"></p>
                  <!-- Campo adicional para indicar si el producto es devuelto -->
                  <input type="hidden" name="es_devuelto" id="esDevuelto" value="false">
              </div>
              <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                  <button type="submit" class="btn btn-success" id="guardarBtn" disabled>
                    <i class="fas fa-save"></i> Guardar
                  </button>
              </div>
          </form>
      </div>
  </div>
</div>

{% endblock %}
