{% extends "inventario/comun/base.html" %}

{% block content %}
<script>
    function abrirModal(productoId, maxCantidad, movimientoId) {
        document.getElementById('productoId').value = productoId;
        document.getElementById('movimientoId').innerText = movimientoId;  
        console.log("Configurando producto ID:", productoId);
        console.log("Configurando Movimiento ID:", movimientoId);    
        document.getElementById('cantidadMaxima').innerText = maxCantidad;
        document.getElementById('cantidadVendida').max = maxCantidad;
        document.getElementById('cantidadDevuelta').max = maxCantidad;
        document.getElementById('cantidadVendida').value = '';
        document.getElementById('cantidadDevuelta').value = '';
        document.getElementById('bodegaDevuelta').value = '';
        document.getElementById('errorMensaje').innerText = ''; // Limpiar mensaje de error
        const modal = new bootstrap.Modal(document.getElementById('recepcionModal'));
        modal.show();
    }
    document.querySelector("form").onsubmit = function() {
      console.log("Enviando Movimiento ID:", document.getElementById('movimientoId').value);
  };
  
    function validarSuma(maxCantidad) {
        const cantidadVendida = parseInt(document.getElementById('cantidadVendida').value || 0, 10);
        const cantidadDevuelta = parseInt(document.getElementById('cantidadDevuelta').value || 0, 10);
        const bodegaDevuelta = document.getElementById('bodegaDevuelta').value;
        const suma = cantidadVendida + cantidadDevuelta;

        if (suma > maxCantidad) {
            document.getElementById('errorMensaje').innerText = 
                `La suma de vendidos y devueltos (${suma}) no puede exceder la cantidad máxima (${maxCantidad}).`;
            document.getElementById('guardarBtn').disabled = true;
        } else if (cantidadDevuelta > 0 && !bodegaDevuelta) {
            document.getElementById('errorMensaje').innerText = 
                "Debe seleccionar una bodega para los productos devueltos.";
            document.getElementById('guardarBtn').disabled = true;
        } else {
            document.getElementById('errorMensaje').innerText = '';
            document.getElementById('guardarBtn').disabled = false;
        }
    }
</script>

<article class="content responsive-tables-page">
    <div class="title-block text-center">
        <h1 class="title">Empleados con Productos Pendientes</h1>
        <p class="title-description">Ver empleados con productos pendientes de recepción</p>
    </div>

    <section class="section">
        <div class="row">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-block">
                        <div class="card-title-block">
                            <h3 class="title">Empleados Pendientes</h3>
                        </div>
                        <section class="example">
                            {% if messages %}
                                {% for message in messages %}
                                    <div class="alert alert-info">{{ message }}</div>
                                {% endfor %}
                            {% endif %}
                            <div class="table-responsive">
                                <table id="listarEmpleadosPendientes" class="table table-striped table-bordered table-hover">
                                    <thead>
                                        <tr>
                                            <th>Nombre</th>
                                            <th>Productos Pendientes</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for empleado_id, empleado_data in empleados.items %}
                                        <tr>
                                            <td>{{ empleado_data.nombre }} {{ empleado_data.apellido }}</td>
                                            <td>
                                                <ul>
                                                    {% for producto_id, producto_data in empleado_data.productos.items %}
                                                    <li>
                                                        {{ producto_data.descripcion }} 
                                                        {{ producto_data.movimiento_id }} 
                                                        (Cantidad: {{ producto_data.cantidad }})
                                                        <button class="btn btn-primary btn-sm" 
                                                                onclick="abrirModal('{{ producto_id }}', {{ producto_data.cantidad }}, {{ producto_data.movimiento_id }})">
                                                          Recepcionar
                                                        </button>
                                                    </li>
                                                    {% endfor %}
                                                </ul>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </section>
                    </div>
                </div>
            </div>
        </div>
    </section>
</article>
<!-- Modal para recepción -->
<div class="modal fade" id="recepcionModal" tabindex="-1" aria-labelledby="recepcionModalLabel" aria-hidden="true">
  <div class="modal-dialog">
      <div class="modal-content">
          <form method="POST" action="{% url 'inventario:recepcion_producto' %}">
              {% csrf_token %}
              <div class="modal-header">
                  <h5 class="modal-title" id="recepcionModalLabel">Recepción de Producto</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                  <input type="hidden" name="producto_id" id="productoId">
                  <input type="hidden" name="movimiento_id" id="movimientoId"> <!-- Campo oculto para movimiento_id -->
                  <p><strong>Cantidad máxima pendiente:</strong> <span id="cantidadMaxima"></span></p>
                  <div class="mb-3">
                      <label for="cantidadVendida" class="form-label">Cantidad Vendida</label>
                      <input type="number" class="form-control" name="cantidad_vendida" id="cantidadVendida" 
                             min="0" oninput="validarSuma(parseInt(document.getElementById('cantidadMaxima').innerText))">
                  </div>
                  <div class="mb-3">
                      <label for="cantidadDevuelta" class="form-label">Cantidad Devuelta</label>
                      <input type="number" class="form-control" name="cantidad_devuelta" id="cantidadDevuelta" 
                             min="0" oninput="validarSuma(parseInt(document.getElementById('cantidadMaxima').innerText))">
                  </div>
                  <div class="mb-3">
                      <label for="bodegaDevuelta" class="form-label">Bodega para devolución</label>
                      <select class="form-select" name="bodega_id" id="bodegaDevuelta" 
                              oninput="validarSuma(parseInt(document.getElementById('cantidadMaxima').innerText))">
                          <option value="" selected>Seleccione una bodega</option>
                          {% for bodega in bodegas %}
                          <option value="{{ bodega.id }}">{{ bodega.nombre }}</option>
                          {% endfor %}
                      </select>
                  </div>
                  <!-- Mostrar el ID de Movimiento de forma discreta -->
                  <p style="font-size: 0.8em; color: #6c757d;">
                      <strong>ID de Movimiento:</strong> <span id="movimientoId"></span>
                  </p>
                  <p id="errorMensaje" class="text-danger"></p>
              </div>
              <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                  <button type="submit" class="btn btn-primary" id="guardarBtn" disabled>Guardar</button>
              </div>
          </form>
      </div>
  </div>
</div>


{% endblock %}
